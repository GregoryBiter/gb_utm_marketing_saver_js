const utmHandler={getUrlParams:()=>{let e={utm_source:"direct",utm_medium:"(not set)",utm_campaign:"(not set)",utm_term:"(not set)",utm_content:"(not set)"};const o=window.location.search,r=new URLSearchParams(o);console.log("URL параметры:",r);const t=document.referrer;return t&&t.includes("l.instagram.com")&&(e.utm_source="instagram",e.utm_medium="social"),e=utmHandler.otherUrlParams(e,r),"direct"!==e.utm_source||r.has("utm_source")||(e=utmHandler.setUtmSourceFromReferrer(e)),["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach((o=>{const t=r.get(o);null!==t&&(e[o]=t)})),e},clearHost:e=>(0===e.indexOf("http://")&&(e=e.slice(7)),0===e.indexOf("https://")&&(e=e.slice(8)),0===e.indexOf("www.")&&(e=e.slice(4)),e),setUtmSourceFromReferrer:e=>{const o=document.referrer;console.log("referrer:",o);const r=window.location.hostname;if(console.log("currentDomain:",r),!o||o.includes(r))return e;if(o.includes("l.instagram.com"))return console.log("Instagram lite link detected"),e.utm_source="instagram",e.utm_medium="social",e;let t="";try{t=new URL(o).hostname,console.log("Original refDomain:",t),t=utmHandler.clearHost(t),console.log("Cleared refDomain:",t)}catch(o){return console.error("Ошибка при парсинге реферрера:",o),e}if(o.includes("some-other-site.com")||"some-other-site.com"===t)return console.log("Referral traffic detected from some-other-site.com"),e.utm_source="some-other-site.com",e.utm_medium="referral",e;if(o.includes("instagram.com")||"instagram.com"===t||"l.instagram.com"===t||t.endsWith(".instagram.com"))return console.log("Instagram found in referrer URL or domain"),e.utm_source="instagram",e.utm_medium="social",e;if(o.includes("google.com/search"))return console.log("Google search detected in referrer URL"),e.utm_source="google",e.utm_medium="organic",e;const m={"google.com":{source:"google",medium:"organic"},"google.com.ua":{source:"google",medium:"organic"},"bing.com":{source:"bing",medium:"organic"},"yahoo.com":{source:"yahoo",medium:"organic"},"duckduckgo.com":{source:"duckduckgo",medium:"organic"},"instagram.com":{source:"instagram",medium:"social"},"l.instagram.com":{source:"instagram",medium:"social"},"facebook.com":{source:"facebook",medium:"social"},"l.facebook.com":{source:"facebook",medium:"social"},"m.facebook.com":{source:"facebook",medium:"social"},"twitter.com":{source:"twitter",medium:"social"},"linkedin.com":{source:"linkedin",medium:"social"}};if("direct"===e.utm_source)if(console.log("Looking for source match for domain:",t),m[t])e.utm_source=m[t].source,e.utm_medium=m[t].medium||"(not set)",console.log("Direct match found:",t,"->",e.utm_source,e.utm_medium);else{let o=!1;for(const[r,s]of Object.entries(m))if(t===r||t.endsWith("."+r)){e.utm_source=s.source,e.utm_medium=s.medium||"(not set)",o=!0,console.log("Domain/subdomain match found:",t,"->",e.utm_source,e.utm_medium);break}o||(e.utm_source=t,e.utm_medium="referral",console.log("No match found, set as referral:",t))}return e},otherUrlParams:(e,o)=>(e.utm_source&&"direct"!==e.utm_source||(o.has("fbclid")?(e.utm_source="facebook",e.utm_medium="social"):o.has("gclid")?(e.utm_source="google",e.utm_medium="cpc"):o.has("dclid")?(e.utm_source="doubleclick",e.utm_medium="display"):o.has("gad_source")&&(e.utm_source="google",e.utm_medium="cpc")),e),setCookie:(e,o,r)=>{let t="";if(r){const e=new Date;e.setTime(e.getTime()+24*r*60*60*1e3),t="; expires="+e.toUTCString()}document.cookie=e+"="+(o||"")+t+"; path=/"},getCookie:e=>{const o=e+"=",r=document.cookie.split(";");for(let e=0;e<r.length;e++){let t=r[e];for(;" "===t.charAt(0);)t=t.substring(1);if(0===t.indexOf(o))return t.substring(o.length)}return null},isExternalReferrer:(e,o)=>e&&!e.includes(o),getReferrerValue:(e,o)=>utmHandler.isExternalReferrer(e,o)?e:"",shouldUpdateSecondVisit:(e,o,r)=>{if("direct"!==e.utm_source)return!0;return!!utmHandler.isExternalReferrer(o,r)},saveUtmAndReferrerToCookies:()=>{const e=utmHandler.getUrlParams(),o=document.referrer,r=window.location.hostname;let t=JSON.parse(utmHandler.getCookie("utm_data")||"{}");t.first_visit||(t.first_visit={utm:e,referrer:utmHandler.getReferrerValue(o,r)}),utmHandler.shouldUpdateSecondVisit(e,o,r)&&(t.second_visit={utm:e,referrer:utmHandler.getReferrerValue(o,r)}),utmHandler.setCookie("utm_data",JSON.stringify(t),30)},getUtmAndReferrerFromCookies:()=>{try{const e=JSON.parse(utmHandler.getCookie("utm_data")||"{}");if(!e.first_visit||!e.first_visit.utm){if(!e.second_visit)return{};e.first_visit=e.second_visit}return e}catch(e){return console.error("Ошибка при чтении куки:",e),{}}}};window.utmHandler=utmHandler,"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=utmHandler),window.onload=()=>{"function"==typeof utmHandler.saveUtmAndReferrerToCookies?(utmHandler.saveUtmAndReferrerToCookies(),console.log(utmHandler.getUtmAndReferrerFromCookies())):console.error("Функция saveUtmAndReferrerToCookies не определена")};