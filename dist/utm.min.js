"use strict";const utmHandler=(()=>{const e=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],t={utm_source:"direct",utm_medium:"(not set)",utm_campaign:"(not set)",utm_term:"(not set)",utm_content:"(not set)"},r={"google.com":{source:"google",medium:"organic"},"google.com.ua":{source:"google",medium:"organic"},"bing.com":{source:"bing",medium:"organic"},"yahoo.com":{source:"yahoo",medium:"organic"},"duckduckgo.com":{source:"duckduckgo",medium:"organic"},"instagram.com":{source:"instagram",medium:"social"},"l.instagram.com":{source:"instagram",medium:"social"},"facebook.com":{source:"facebook",medium:"social"},"l.facebook.com":{source:"facebook",medium:"social"},"m.facebook.com":{source:"facebook",medium:"social"},"twitter.com":{source:"twitter",medium:"social"},"linkedin.com":{source:"linkedin",medium:"social"}},o=(e,t=null)=>{try{"undefined"!=typeof process&&"production"===process.env.NODE_ENV||(t?console.log(e,t):console.log(e))}catch(e){}},m=e=>{if(!e)return"";let t=e;return 0===t.indexOf("http://")&&(t=t.slice(7)),0===t.indexOf("https://")&&(t=t.slice(8)),0===t.indexOf("www.")&&(t=t.slice(4)),t},u=(e,t)=>e&&!e.includes(t),i=(e,t)=>u(e,t)?e:"";return{getUrlParams:()=>{let r={...t};const m=window.location.search,u=new URLSearchParams(m);o("URL параметры:",u);const i=document.referrer;return i&&i.includes("l.instagram.com")&&(r.utm_source="instagram",r.utm_medium="social"),r=utmHandler.otherUrlParams(r,u),"direct"!==r.utm_source||u.has("utm_source")||(r=utmHandler.setUtmSourceFromReferrer(r)),e.forEach((e=>{const t=u.get(e);null!==t&&(r[e]=t)})),r},clearHost:m,setUtmSourceFromReferrer:e=>{const t=document.referrer;o("referrer:",t);const u=window.location.hostname;if(o("currentDomain:",u),!t||t.includes(u))return e;if(t.includes("l.instagram.com"))return o("Instagram lite link detected"),e.utm_source="instagram",e.utm_medium="social",e;let i="";if(!(e=>{try{let t=e;return e.match(/^[a-zA-Z]+:\/\//)||(t="http://"+e),new URL(t),!0}catch(e){return!1}})(t))return o("Некорректный URL реферера:",t),e;try{if(i=(e=>{try{let t=e;e.match(/^[a-zA-Z]+:\/\//)||(t="http://"+e);const r=new URL(t).hostname;return m(r)}catch(t){o("Не удалось распарсить URL, пытаемся извлечь домен вручную:",e);let r=e.replace(/^(https?:\/\/)?(www\.)?/i,"");return r=r.split(/[/?#]/)[0],r||""}})(t),o("Извлеченный домен реферера:",i),!i)return o("Не удалось извлечь домен из реферера"),e}catch(t){return o("Ошибка при парсинге реферрера:",t),e}if(t.includes("google.com/search"))return o("Google search detected in referrer URL"),e.utm_source="google",e.utm_medium="organic",e;if("direct"===e.utm_source)if(o("Looking for source match for domain:",i),r[i])e.utm_source=r[i].source,e.utm_medium=r[i].medium||"(not set)",o("Direct match found:",i,e.utm_source,e.utm_medium);else{let t=!1;for(const[m,u]of Object.entries(r))if(i===m||i.endsWith("."+m)){e.utm_source=u.source,e.utm_medium=u.medium||"(not set)",t=!0,o("Domain/subdomain match found:",i,e.utm_source,e.utm_medium);break}!t&&i&&"invalid-url"!==i&&(e.utm_source=i,e.utm_medium="referral",o("No match found, set as referral:",i))}return e},otherUrlParams:(e,t)=>(e.utm_source&&"direct"!==e.utm_source||(t.has("fbclid")?(e.utm_source="facebook",e.utm_medium="social"):t.has("gclid")?(e.utm_source="google",e.utm_medium="cpc"):t.has("dclid")?(e.utm_source="doubleclick",e.utm_medium="display"):t.has("gad_source")&&(e.utm_source="google",e.utm_medium="cpc")),e),setCookie:(e,t,r=30)=>{let o="";if(r){const e=new Date;e.setTime(e.getTime()+24*r*60*60*1e3),o="; expires="+e.toUTCString()}document.cookie=`${e}=${t||""}${o}; path=/; SameSite=Lax`},getCookie:e=>{if(!document.cookie)return null;const t=e+"=",r=document.cookie.split(";");for(let e=0;e<r.length;e++){let o=r[e].trim();if(0===o.indexOf(t)){const e=o.substring(t.length);return e||null}}return null},isExternalReferrer:u,getReferrerValue:i,shouldUpdateSecondVisit:(e,t,r)=>"direct"!==e.utm_source||Boolean(u(t,r)),getUtmAndReferrerFromCookies:()=>{try{const e=utmHandler.getCookie("utm_data");if(!e)return o("Cookie utm_data отсутствует или пустая"),{};if(!e.trim().startsWith("{"))return o("Cookie utm_data содержит некорректные данные:",e),{};const t=JSON.parse(e);if(!t.first_visit||!t.first_visit.utm){if(!t.second_visit)return{};t.first_visit=t.second_visit}return t}catch(e){o("Ошибка при чтении куки:",e);try{utmHandler.setCookie("utm_data","{}"),o("Некорректная кука utm_data была сброшена")}catch(e){o("Не удалось сбросить некорректную куку:",e)}return{}}},saveUtmAndReferrerToCookies:()=>{try{const e=utmHandler.getUrlParams(),t=document.referrer,r=window.location.hostname;let m={};const u=utmHandler.getCookie("utm_data");if(u)try{u.trim().startsWith("{")&&(m=JSON.parse(u))}catch(e){o("Ошибка при чтении куки, создаем новую",e)}m.first_visit||(m.first_visit={utm:e,referrer:i(t,r),timestamp:(new Date).toISOString()}),utmHandler.shouldUpdateSecondVisit(e,t,r)&&(m.second_visit={utm:e,referrer:i(t,r),timestamp:(new Date).toISOString()}),utmHandler.setCookie("utm_data",JSON.stringify(m))}catch(e){o("Ошибка при сохранении UTM данных",e);try{utmHandler.setCookie("utm_data","{}")}catch(e){o("Не удалось сбросить куку:",e)}}}}})();window.utmHandler=utmHandler,"undefined"!=typeof module&&void 0!==module.exports&&(module.exports=utmHandler),document.addEventListener("DOMContentLoaded",(()=>{"function"==typeof utmHandler.saveUtmAndReferrerToCookies?(utmHandler.saveUtmAndReferrerToCookies(),console.log("UTM данные:",utmHandler.getUtmAndReferrerFromCookies())):console.error("Функция saveUtmAndReferrerToCookies не определена")}));